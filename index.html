<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Boo Writer</title>
  <meta name="description" content="A calm, mindful space to write." />

  <style>
    :root{
      /* Paper theme only (default on landing) */
      --bg:#f3f0e7;
      --panel: rgba(0,0,0,.06);
      --panel2: rgba(0,0,0,.08);
      --text: rgba(18,18,18,.92);
      --muted: rgba(18,18,18,.70);
      --muted2: rgba(18,18,18,.55);
      --line: rgba(0,0,0,.14);
      --btn: rgba(0,0,0,.06);
      --btnHover: rgba(0,0,0,.09);
      --shadow: 0 20px 60px rgba(0,0,0,.18);
      --editorBg: rgba(255,255,255,.65);
      --editorText: rgba(18,18,18,.92);
      --editorCaret: rgba(18,18,18,.85);
      --link: rgba(18,18,18,.72);
      --overlayBg: rgba(0,0,0,.15);

      /* Layout width control */
      --editorMax: 920px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
      overflow:auto;
    }

    .app{
      height:100%;
      width:100%;
      position:relative;
      display:flex;
      flex-direction:column;
    }

    /* Fade screens */
    .screen{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      opacity:0;
      pointer-events:none;
      transition: opacity 520ms ease;
    }
    .screen.active{
      opacity:1;
      pointer-events:auto;
    }
    .centerStack{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:18px;
      text-align:center;
      width: min(520px, 100%);
    }
    .welcomeTitle{
      font-size: clamp(22px, 4vw, 34px);
      letter-spacing:.2px;
      font-weight: 520;
      color: var(--text);
      opacity:0;
      transform: translateY(4px);
      transition: opacity 700ms ease, transform 700ms ease;
    }
    .welcomeTitle.show{
      opacity:1;
      transform: translateY(0px);
    }
    .beginBtn{
      border:1px solid var(--line);
      background: var(--btn);
      color: var(--text);
      padding: 10px 18px;
      border-radius: 999px;
      font-size: 14px;
      cursor:pointer;
      opacity:0;
      transform: translateY(6px);
      transition: opacity 700ms ease, transform 700ms ease, background 180ms ease;
    }
    .beginBtn:hover{ background: var(--btnHover); }
    .beginBtn.show{
      opacity:1;
      transform: translateY(0px);
    }

    /* Name screen */
    .nameQuestion{
      font-size: clamp(20px, 3.6vw, 30px);
      letter-spacing:.2px;
      font-weight: 520;
      color: var(--text);
      opacity:0;
      transform: translateY(4px);
      transition: opacity 700ms ease, transform 700ms ease;
    }
    .nameQuestion.show{
      opacity:1;
      transform: translateY(0px);
    }
    .nameInput{
      width: min(420px, 92vw);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 12px 14px;
      background: rgba(255,255,255,.65);
      color: var(--text);
      font-size: 14px;
      outline: none;
      opacity:0;
      transform: translateY(6px);
      transition: opacity 700ms ease, transform 700ms ease, background 180ms ease, border-color 180ms ease;
      text-align:center;
    }
    .nameInput:focus{
      background: rgba(255,255,255,.78);
      border-color: rgba(0,0,0,.20);
    }
    .nameInput.show{
      opacity:1;
      transform: translateY(0px);
    }
    .nameHint{
      margin-top: -6px;
      font-size: 12px;
      color: var(--muted2);
      line-height: 1.35;
      opacity:0;
      transform: translateY(6px);
      transition: opacity 700ms ease, transform 700ms ease;
    }
    .nameHint.show{
      opacity:1;
      transform: translateY(0px);
    }

    /* Writer screen */
    .writer{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      opacity:0;
      pointer-events:none;
      transition: opacity 520ms ease;
      min-height: 100vh;
      transform-origin: 50% 18%;
      will-change: transform, filter;
    }
    .writer.active{
      opacity:1;
      pointer-events:auto;
    }

    /* Top bar spans the same width as the writing page */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      background: var(--bg);
      display:flex;
      justify-content:center;
      padding: 8px 16px 2px;
    }

    .topbarInner{
      width:min(var(--editorMax), 100%);
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
    }

    .toolbar{
      display:flex;
      align-items:center;
      flex-wrap:wrap;
      gap:10px;
      min-width:0;
      flex:1;
    }

    .toolGroup{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 6px 8px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: var(--panel);
      backdrop-filter: blur(10px);
      flex-wrap:wrap;
      max-width:100%;
    }

    .toolBtn{
      border:1px solid transparent;
      background: transparent;
      color: var(--text);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      cursor:pointer;
      transition: background 180ms ease, border-color 180ms ease, opacity 180ms ease;
      white-space:nowrap;
    }
    .toolBtn:hover{ background: var(--btn); border-color: var(--line); }
    .toolBtn:disabled{ opacity:.45; cursor:not-allowed; }
    .toolBtn.toggled{ background: var(--btnHover); border-color: var(--line); }

    select{
      background: transparent;
      color: var(--text);
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      outline:none;
      cursor:pointer;
      max-width: 100%;
    }
    select option{ color:#111; }

    .appIconWrap{
      flex-shrink:0;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding-bottom: 0;
      position: relative;
    }

    .appIconBtn{
      border: none;
      background: transparent;
      padding: 0;
      margin: 0;
      cursor: pointer;
      display:flex;
      align-items:flex-end;
      border-radius: 14px;
    }
    .appIconBtn:focus-visible{
      outline: none;
      box-shadow: 0 0 0 3px rgba(0,0,0,.10);
    }

    .appIcon{
      width:90px;
      height:90px;
      border-radius:0px;
      object-fit:contain;
      opacity:.95;
      transition: opacity 180ms ease, transform 120ms ease;
      display:block;
    }
    .appIconBtn:hover .appIcon{
      opacity:1;
      transform: scale(1.03);
    }

    /* Writing area */
    .editorWrap{
      flex:1;
      min-height: 0;
      display:flex;
      align-items:stretch;
      justify-content:center;
      padding: 0 16px 0;
      margin-top: 4px;
    }
    .editor{
      width:min(var(--editorMax), 100%);
      height:100%;
      padding: 26px 22px;
      border-radius: 18px;
      border:1px solid var(--line);
      background: var(--editorBg);
      color: var(--editorText);
      box-shadow: var(--shadow);
      outline:none;
      overflow:auto;
      line-height: 1.7;
      font-size: 20px;
      caret-color: var(--editorCaret);
      font-family: ui-serif, Georgia, "Times New Roman", Times, serif;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Footer spans same width as editor */
    .footer{
      display:flex;
      justify-content:center;
      padding: 10px 16px 14px;
      color: var(--muted2);
      font-size: 12px;
      gap:12px;
    }
    .footerInner{
      width:min(var(--editorMax), 100%);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .footer a{
      color: var(--link);
      text-decoration: none;
      border-bottom: 1px solid transparent;
    }
    .footer a:hover{ border-bottom-color: var(--line); }

    /* Modal overlay */
    .overlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      background: var(--overlayBg);
      opacity:0;
      pointer-events:none;
      transition: opacity 320ms ease;
      z-index: 70;
    }
    .overlay.active{
      opacity:1;
      pointer-events:auto;
    }
    .card{
      width:min(520px, 100%);
      border-radius: 22px;
      border:1px solid var(--line);
      background: var(--panel2);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .card h2{
      margin: 2px 0 12px;
      font-size: 16px;
      font-weight: 560;
      color: var(--text);
    }
    .card p{
      margin: 0 0 12px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }
    .cardActions{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 10px;
    }
    .primaryBtn, .secondaryBtn{
      width:100%;
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      border:1px solid var(--line);
      background: var(--btn);
      color: var(--text);
      font-size: 13px;
      transition: background 180ms ease;
    }
    .primaryBtn:hover, .secondaryBtn:hover{ background: var(--btnHover); }

    .closeArea{
      margin-top: 14px;
      display:flex;
      justify-content:center;
    }
    .closeLink{
      border:none;
      background: transparent;
      color: var(--muted);
      cursor:pointer;
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid transparent;
    }
    .closeLink:hover{
      color: var(--text);
      border-color: var(--line);
      background: var(--btn);
    }

    .docList{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height: 260px;
      overflow:auto;
      padding-right: 4px;
    }
    .docRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      border:1px solid var(--line);
      border-radius: 14px;
      background: rgba(0,0,0,.03);
    }
    .docMeta{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .docName{
      font-size: 13px;
      color: var(--text);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 290px;
    }
    .docSub{
      font-size: 11px;
      color: var(--muted2);
    }
    .docBtns{
      display:flex;
      gap:8px;
      flex-shrink:0;
    }

    .sr-only{
      position:absolute!important;
      width:1px!important;
      height:1px!important;
      padding:0!important;
      margin:-1px!important;
      overflow:hidden!important;
      clip:rect(0,0,0,0)!important;
      white-space:nowrap!important;
      border:0!important;
    }

    /***********************
     * ‚úÖ Boo companion UI
     ***********************/
    .booPanel{
      position: fixed;
      right: 16px;
      bottom: 16px;
      width: min(360px, calc(100vw - 32px));
      z-index: 65; /* below overlays (70), above editor */
      border: 1px solid var(--line);
      border-radius: 18px;
      background: rgba(255,255,255,.72);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      padding: 12px;
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none;
      transition: opacity 220ms ease, transform 220ms ease;
    }
    .booPanel.active{
      opacity: 1;
      transform: translateY(0px);
      pointer-events: auto;
    }
    .booHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 6px;
    }
    .booTitle{
      font-size: 12px;
      color: var(--muted2);
      letter-spacing:.2px;
      user-select:none;
    }
    .booClose{
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      cursor:pointer;
      font-size: 12px;
      border-radius: 999px;
      padding: 6px 10px;
      transition: background 180ms ease, border-color 180ms ease, color 180ms ease;
    }
    .booClose:hover{
      background: var(--btn);
      border-color: var(--line);
      color: var(--text);
    }
    .booLines{
      font-family: ui-serif, Georgia, "Times New Roman", Times, serif;
      font-size: 16px;
      line-height: 1.5;
      color: var(--text);
      margin: 6px 0 10px;
      white-space: pre-wrap;
    }
    .booChoices{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .booChoiceBtn{
      border:1px solid var(--line);
      background: var(--btn);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      cursor:pointer;
      transition: background 180ms ease;
    }
    .booChoiceBtn:hover{ background: var(--btnHover); }

    .booInputWrap{
      margin: 8px 0 10px;
      display:none;
    }
    .booInputWrap.active{ display:block; }
    .booInput{
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(255,255,255,.75);
      font-size: 14px;
      outline:none;
      color: var(--text);
    }
    .booHint{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted2);
      line-height: 1.35;
    }

    /* Phone friendliness */
    @media (max-width: 540px){
      .topbar{ padding: 8px 10px 2px; }
      .topbarInner{ gap:8px; }
      .toolGroup{ padding: 6px; border-radius: 18px; }
      .toolBtn, select{ font-size: 12px; padding: 8px 10px; }
      .editorWrap{ padding: 0 10px; margin-top: 4px; }
      .editor{ padding: 20px 16px; border-radius: 16px; }
      .footer{ padding: 8px 10px 12px; }
      .footerInner{ flex-direction:column; align-items:flex-start; gap:6px; }

      .appIcon{ width:56px; height:56px; border-radius:12px; }

      .booPanel{
        right: 10px;
        bottom: 10px;
        width: min(360px, calc(100vw - 20px));
      }
    }

    @media (prefers-reduced-motion: reduce){
      .booPanel{ transition:none; }
      .screen, .welcomeTitle, .beginBtn, .nameQuestion, .nameInput, .nameHint{ transition:none; transform:none; }
    }
  </style>
</head>

<script data-goatcounter="https://boo-writer.goatcounter.com/count"
  async src="//gc.zgo.at/count.js"></script>

<body>
  <div class="app">

    <!-- WELCOME SCREEN -->
    <section id="welcomeScreen" class="screen active" aria-label="Welcome">
      <div class="centerStack">
        <div id="welcomeTitle" class="welcomeTitle">Welcome to Boo Writer.</div>
        <button id="beginBtn" class="beginBtn" type="button">Let‚Äôs begin</button>
      </div>
    </section>

    <!-- NAME SCREEN (between welcome and writer) -->
    <section id="nameScreen" class="screen" aria-label="Your name">
      <div class="centerStack">
        <div id="nameQuestion" class="nameQuestion">Choose your username</div>
        <input
          id="nameInput"
          class="nameInput"
          type="text"
          inputmode="text"
          autocomplete="name"
          maxlength="32"
          placeholder="Type your name‚Ä¶"
          aria-label="Your name"
        />
        <div id="nameHint" class="nameHint">This stays on this device.</div>
        <button id="nameContinueBtn" class="beginBtn" type="button">Continue</button>
      </div>
    </section>

    <!-- WRITER SCREEN -->
    <main id="writerScreen" class="writer" aria-label="Writer">
      <header class="topbar">
        <div class="topbarInner">

          <div class="toolbar">
            <div class="toolGroup" aria-label="Document">
              <button class="toolBtn" id="openBtn" type="button">Open document</button>
              <button class="toolBtn" id="saveBtn" type="button" title="Save to Boo Writer">Save work</button>
              <button class="toolBtn" id="finishBtn" type="button">Finish session</button>
            </div>

            <div class="toolGroup" aria-label="Typography">
              <label class="sr-only" for="fontSelect">Font</label>
              <select id="fontSelect" title="Font">
                <option value='ui-serif, Georgia, "Times New Roman", Times, serif'>Serif</option>
                <option value='ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif'>Sans</option>
                <option value='"Iowan Old Style", "Palatino Linotype", Palatino, serif'>Palatino</option>
                <option value='"Baskerville", "Baskerville Old Face", serif'>Baskerville</option>
                <option value='"Garamond", "Adobe Garamond Pro", serif'>Garamond</option>
                <option value='"Georgia", Georgia, serif'>Georgia</option>
                <option value='"Times New Roman", Times, serif'>Times</option>
                <option value='"Courier New", Courier, monospace'>Courier</option>
                <option value='ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace'>Mono</option>
                <option value='"Trebuchet MS", Trebuchet, sans-serif'>Trebuchet</option>
                <option value='"Verdana", Verdana, sans-serif'>Verdana</option>
                <option value='"Arial", Arial, sans-serif'>Arial</option>
              </select>

              <label class="sr-only" for="fontSize">Font size</label>
              <select id="fontSize" title="Font size"></select>

              <button class="toolBtn" id="alignLeftBtn" type="button" title="Left align">Left</button>
              <button class="toolBtn" id="alignJustifyBtn" type="button" title="Justify">Justify</button>
              <button class="toolBtn" id="indentBtn" type="button" title="Indent first line">Indent</button>
            </div>

            <div class="toolGroup" aria-label="History">
              <button class="toolBtn" id="undoBtn" type="button" title="Undo">Undo</button>
              <button class="toolBtn" id="redoBtn" type="button" title="Redo">Redo</button>
            </div>
          </div>

          <!-- Boo Writer icon (top right) -->
          <div class="appIconWrap">
            <button
              id="booIconBtn"
              class="appIconBtn"
              type="button"
              aria-label="Boo Writer"
              title="Boo Writer"
            >
              <img
                src="assets/icon/boo-writer.png"
                alt=""
                class="appIcon"
                aria-hidden="true"
              />
            </button>
          </div>

        </div>
      </header>

      <section class="editorWrap" aria-label="Writing area">
        <div
          id="editor"
          class="editor"
          contenteditable="true"
          role="textbox"
          aria-multiline="true"
          spellcheck="true"
        ></div>
      </section>

      <footer class="footer">
        <div class="footerInner">
          <div>¬© 2025 James Ritchie &amp; www.boo-industries.com. All rights reserved. Contact: jamesalexritchie@outlook.com</div>
          <div><a href="#" id="privacyLink">Privacy &amp; data usage statement</a></div>
        </div>
      </footer>
    </main>

    <!-- OPEN DOCUMENT MODAL -->
    <div id="openOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="openTitle">
      <div class="card">
        <h2 id="openTitle">Open document</h2>
        <p>Your saved work lives here. Choose a document to open, or start fresh.</p>
        <div id="docList" class="docList"></div>

        <div class="cardActions">
          <button id="newDocBtn" class="secondaryBtn" type="button">Start a new document</button>
        </div>

        <div class="closeArea">
          <button id="closeOpenOverlay" class="closeLink" type="button">Close</button>
        </div>
      </div>
    </div>

    <!-- FINISH SESSION MODAL -->
    <div id="finishOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="finishTitle">
      <div class="card">
        <h2 id="finishTitle">End session</h2>
        <p>Export your work. Your words are safe.</p>

        <div class="cardActions">
          <button id="downloadRtfBtn" class="primaryBtn" type="button">Download rich text file</button>
          <button id="emailExportBtn" class="secondaryBtn" type="button">Email export</button>
        </div>

        <div class="closeArea">
          <button id="restartBtn" class="closeLink" type="button">Close</button>
        </div>
      </div>
    </div>

    <!-- PRIVACY MODAL -->
    <div id="privacyOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="privacyTitle">
      <div class="card">
        <h2 id="privacyTitle">Privacy &amp; data usage</h2>
        <p>
          Boo Writer stores your documents locally in your browser (on this device) using local storage.
          We don‚Äôt upload your writing anywhere from this page.
        </p>
        <p>
          If you use ‚ÄúEmail export‚Äù, your email app will open and you choose what to send.
        </p>
        <div class="closeArea">
          <button id="closePrivacy" class="closeLink" type="button">Close</button>
        </div>
      </div>
    </div>

  </div>

  <!-- Boo companion panel -->
  <aside id="booPanel" class="booPanel" aria-live="polite" aria-label="Boo">
    <div class="booHeader">
      <div class="booTitle">Boo</div>
      <button id="booCloseBtn" class="booClose" type="button">Close</button>
    </div>

    <div id="booLines" class="booLines"></div>

    <div id="booInputWrap" class="booInputWrap">
      <input id="booInput" class="booInput" type="text" autocomplete="off" />
      <div id="booHint" class="booHint"></div>
    </div>

    <div id="booChoices" class="booChoices"></div>
  </aside>

  <script>
    // ---------------------------
    // Boo Writer ‚Äî single-file v1
    // ---------------------------

    const $ = (id) => document.getElementById(id);

    const welcomeScreen = $("welcomeScreen");
    const welcomeTitle  = $("welcomeTitle");
    const beginBtn      = $("beginBtn");

    const nameScreen = $("nameScreen");
    const nameQuestion = $("nameQuestion");
    const nameInput = $("nameInput");
    const nameHint = $("nameHint");
    const nameContinueBtn = $("nameContinueBtn");

    const writerScreen  = $("writerScreen");
    const editor        = $("editor");

    const openBtn       = $("openBtn");
    const saveBtn       = $("saveBtn");
    const finishBtn     = $("finishBtn");

    const fontSelect    = $("fontSelect");
    const fontSize      = $("fontSize");

    const alignLeftBtn  = $("alignLeftBtn");
    const alignJustifyBtn = $("alignJustifyBtn");
    const indentBtn     = $("indentBtn");

    const undoBtn       = $("undoBtn");
    const redoBtn       = $("redoBtn");

    const openOverlay   = $("openOverlay");
    const closeOpenOverlay = $("closeOpenOverlay");
    const docList       = $("docList");
    const newDocBtn     = $("newDocBtn");

    const finishOverlay = $("finishOverlay");
    const downloadRtfBtn= $("downloadRtfBtn");
    const emailExportBtn= $("emailExportBtn");
    const restartBtn    = $("restartBtn");

    const privacyLink   = $("privacyLink");
    const privacyOverlay= $("privacyOverlay");
    const closePrivacy  = $("closePrivacy");

    const booIconBtn = $("booIconBtn");

    // Boo UI
    const booPanel = $("booPanel");
    const booCloseBtn = $("booCloseBtn");
    const booLinesEl = $("booLines");
    const booChoicesEl = $("booChoices");
    const booInputWrap = $("booInputWrap");
    const booInput = $("booInput");
    const booHintEl = $("booHint");

    // --- Font size mapping ---
    const SIZE_SCALE = 1.55;
    const MIN_SIZE = 8;
    const MAX_SIZE = 36;
    const DEFAULT_UI_SIZE = 16;

    for (let s = MIN_SIZE; s <= MAX_SIZE; s += 1) {
      const opt = document.createElement("option");
      opt.value = String(s);
      opt.textContent = String(s);
      if (s === DEFAULT_UI_SIZE) opt.selected = true;
      fontSize.appendChild(opt);
    }

    // State
    const STORAGE_KEY = "boo_writer_docs_v1";
    const SETTINGS_KEY = "boo_writer_settings_v1";
    const SESSION_KEY = "boo_writer_current_doc_id_v1";

    // Boo state
    const BOO_STATE_KEY = "boo_writer_boo_state_v1";
    const BOO_SCENES_URL = "assets/boo/summonboo/scenes.json";

    let currentDocId = null;
    let history = [];
    let historyIndex = -1;
    let applyingHistory = false;
    let indentEnabled = false;
    let alignment = "left";

    function nowIso() { return new Date().toISOString(); }

    function loadDocs(){
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }
      catch { return {}; }
    }
    function saveDocs(docs){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(docs));
    }

    function loadSettings(){
      try { return JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}"); }
      catch { return {}; }
    }
    function saveSettings(s){
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
    }

    function escapeTextForRtf(text){
      return text
        .replace(/\\/g, "\\\\")
        .replace(/{/g, "\\{")
        .replace(/}/g, "\\}")
        .replace(/\r?\n/g, "\\par\n");
    }

    function getPlainText(){
      return (editor.textContent || "").replace(/\u00A0/g, " ");
    }

    function setPlainText(text){
      editor.textContent = text || "";
    }

    function uiToPx(uiSize){
      const n = Number(uiSize);
      const scaled = Math.round(n * SIZE_SCALE);
      return Math.max(12, scaled);
    }

    function applyTypography(){
      editor.style.fontFamily = fontSelect.value;

      const px = uiToPx(fontSize.value);
      editor.style.fontSize = px + "px";

      editor.style.textAlign = alignment;
      editor.style.textJustify = (alignment === "justify") ? "inter-word" : "auto";
      editor.style.textIndent = indentEnabled ? "2em" : "0";

      alignLeftBtn.classList.toggle("toggled", alignment === "left");
      alignJustifyBtn.classList.toggle("toggled", alignment === "justify");
      indentBtn.classList.toggle("toggled", indentEnabled);

      const settings = loadSettings();
      settings.fontFamily = fontSelect.value;
      settings.fontSizeUI = Number(fontSize.value);
      settings.alignment = alignment;
      settings.indentEnabled = indentEnabled;
      saveSettings(settings);
    }

    function showOverlay(el){
      el.classList.add("active");
      const focusable = el.querySelector("button, [href], select, input, textarea, [tabindex]:not([tabindex='-1'])");
      if (focusable) focusable.focus();
    }
    function hideOverlay(el){
      el.classList.remove("active");
      editor.focus();
    }

    function fadeToName(){
      welcomeScreen.classList.remove("active");
      nameScreen.classList.add("active");
      // animate in
      setTimeout(() => {
        nameQuestion.classList.add("show");
        setTimeout(() => nameInput.classList.add("show"), 240);
        setTimeout(() => nameHint.classList.add("show"), 420);
        setTimeout(() => nameContinueBtn.classList.add("show"), 520);
        setTimeout(() => nameInput.focus(), 560);
      }, 40);
    }

    function fadeToWriter(){
      nameScreen.classList.remove("active");
      writerScreen.classList.add("active");
      setTimeout(() => editor.focus(), 560);
    }

    function fadeToWelcome(){
      writerScreen.classList.remove("active");
      nameScreen.classList.remove("active");
      welcomeScreen.classList.add("active");

      // reset animations
      welcomeTitle.classList.remove("show");
      beginBtn.classList.remove("show");

      nameQuestion.classList.remove("show");
      nameInput.classList.remove("show");
      nameHint.classList.remove("show");
      nameContinueBtn.classList.remove("show");

      setTimeout(() => {
        welcomeTitle.classList.add("show");
        setTimeout(() => beginBtn.classList.add("show"), 420);
      }, 40);
    }

    function newDocument(){
      const id = "doc_" + Math.random().toString(36).slice(2) + "_" + Date.now();
      const docs = loadDocs();
      docs[id] = {
        id,
        name: "Untitled",
        content: "",
        createdAt: nowIso(),
        updatedAt: nowIso(),
      };
      saveDocs(docs);
      openDocument(id);
    }

    function openDocument(id){
      const docs = loadDocs();
      const doc = docs[id];
      if (!doc) return;

      currentDocId = id;
      localStorage.setItem(SESSION_KEY, id);

      setPlainText(doc.content || "");
      resetHistory();
      pushHistory(getPlainText());

      hideOverlay(openOverlay);
      editor.focus();
    }

    function renameIfUntitled(docs, id){
      const doc = docs[id];
      if (!doc) return;
      if (doc.name && doc.name !== "Untitled") return;

      const firstLine = (doc.content || "")
        .split(/\r?\n/)
        .map(l => l.trim())
        .find(l => l.length > 0);

      if (firstLine){
        doc.name = firstLine.slice(0, 40);
      }
    }

    function saveCurrent(){
      const docs = loadDocs();
      if (!currentDocId || !docs[currentDocId]) {
        newDocument();
        return;
      }
      const doc = docs[currentDocId];
      doc.content = getPlainText();
      doc.updatedAt = nowIso();
      renameIfUntitled(docs, currentDocId);
      saveDocs(docs);
      pulseButton(saveBtn);
    }

    function pulseButton(btn){
      btn.style.transform = "scale(0.98)";
      setTimeout(() => btn.style.transform = "scale(1)", 140);
    }

    function deleteDocument(id){
      const docs = loadDocs();
      if (!docs[id]) return;
      delete docs[id];
      saveDocs(docs);

      if (currentDocId === id){
        currentDocId = null;
        localStorage.removeItem(SESSION_KEY);
        setPlainText("");
        resetHistory();
        pushHistory("");
      }
      renderDocList();
    }

    function renderDocList(){
      const docs = loadDocs();
      const entries = Object.values(docs)
        .sort((a,b) => (b.updatedAt || "").localeCompare(a.updatedAt || ""));

      docList.innerHTML = "";

      if (entries.length === 0){
        const empty = document.createElement("p");
        empty.style.margin = "6px 0 0";
        empty.style.color = "var(--muted)";
        empty.style.fontSize = "13px";
        empty.textContent = "No saved documents yet.";
        docList.appendChild(empty);
        return;
      }

      for (const d of entries){
        const row = document.createElement("div");
        row.className = "docRow";

        const meta = document.createElement("div");
        meta.className = "docMeta";

        const name = document.createElement("div");
        name.className = "docName";
        name.textContent = d.name || "Untitled";

        const sub = document.createElement("div");
        sub.className = "docSub";
        const date = d.updatedAt ? new Date(d.updatedAt) : null;
        sub.textContent = date ? ("Last saved: " + date.toLocaleString()) : "";

        meta.appendChild(name);
        meta.appendChild(sub);

        const btns = document.createElement("div");
        btns.className = "docBtns";

        const open = document.createElement("button");
        open.className = "toolBtn";
        open.type = "button";
        open.textContent = "Open";
        open.onclick = () => openDocument(d.id);

        const del = document.createElement("button");
        del.className = "toolBtn";
        del.type = "button";
        del.textContent = "Delete";
        del.onclick = () => {
          const ok = confirm(`Delete "${d.name || "Untitled"}"? This cannot be undone.`);
          if (ok) deleteDocument(d.id);
        };

        btns.appendChild(open);
        btns.appendChild(del);

        row.appendChild(meta);
        row.appendChild(btns);
        docList.appendChild(row);
      }
    }

    // History (simple text snapshots)
    function resetHistory(){
      history = [];
      historyIndex = -1;
      updateHistoryButtons();
    }
    function pushHistory(text){
      if (applyingHistory) return;

      if (historyIndex < history.length - 1){
        history = history.slice(0, historyIndex + 1);
      }
      if (history.length > 0 && history[history.length - 1] === text) return;

      history.push(text);
      historyIndex = history.length - 1;

      const MAX = 80;
      if (history.length > MAX){
        const excess = history.length - MAX;
        history = history.slice(excess);
        historyIndex = history.length - 1;
      }
      updateHistoryButtons();
    }

    function updateHistoryButtons(){
      undoBtn.disabled = historyIndex <= 0;
      redoBtn.disabled = historyIndex >= history.length - 1;
    }

    function undo(){
      if (historyIndex <= 0) return;
      historyIndex -= 1;
      applyingHistory = true;
      setPlainText(history[historyIndex]);
      applyingHistory = false;
      updateHistoryButtons();
    }
    function redo(){
      if (historyIndex >= history.length - 1) return;
      historyIndex += 1;
      applyingHistory = true;
      setPlainText(history[historyIndex]);
      applyingHistory = false;
      updateHistoryButtons();
    }

    function downloadRtf(){
      const text = getPlainText();
      const rtf =
        "{\\rtf1\\ansi\\deff0\n" +
        "{\\fonttbl{\\f0 " + (fontSelect.selectedOptions[0]?.textContent || "Serif") + ";}}\n" +
        "\\f0\\fs" + (uiToPx(fontSize.value) * 2) + "\n" +
        escapeTextForRtf(text) +
        "\n}";

      const blob = new Blob([rtf], { type: "application/rtf" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      const stamp = new Date().toISOString().slice(0,10);
      a.href = url;
      a.download = `boo-writer-${stamp}.rtf`;
      document.body.appendChild(a);
      a.click();
      a.remove();

      URL.revokeObjectURL(url);
    }

    function emailExport(){
      const text = getPlainText();
      const subject = encodeURIComponent("Boo Writer export");
      const body = encodeURIComponent(text.slice(0, 8000));
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
    }

    function runWelcomeAnimation(){
      setTimeout(() => welcomeTitle.classList.add("show"), 160);
      setTimeout(() => beginBtn.classList.add("show"), 680);
    }

    // ---------------------------
    // Boo companion engine (non-AI, choice-based)
    // ---------------------------

    const DEFAULT_SCENES = {
      meta: {
        version: "1.0",
        allowSummonWhenMuted: true
      },
      scenes: {
        intro_1: {
          lines: [
            "Hi‚Ä¶ I‚Äôm Boo. I live in Boo Writer üëª",
            "Hello. I‚Äôm Boo ‚Äî a little ghost in the machine üëª"
          ],
          choices: [
            { label: "Who are you?", goto: "who_1" },
            { label: "Thank you, Boo‚Ä¶", goto: "thanks_1", effects: [{ type:"affinity", delta: 1 }] },
            { label: "Say less‚Ä¶", goto: "mute_1", effects: [{ type:"set", key:"booMuted", value:true }] }
          ]
        },
        who_1: {
          lines: [
            "I drift around your words and keep you company.",
            "I‚Äôm here for the quiet parts ‚Äî the parts that just need someone nearby."
          ],
          choices: [
            { label: "A ghost?!", goto: "ghost_1" },
            { label: "Okay. Stay close.", goto: "stay_1", effects: [{ type:"affinity", delta: 1 }] },
            { label: "Say less‚Ä¶", goto: "mute_1", effects: [{ type:"set", key:"booMuted", value:true }] }
          ]
        },
        ghost_1: {
          lines: [
            "That‚Äôs right. A friendly one. I won‚Äôt get in the way üôÇ",
            "Yep. I‚Äôm here whenever you need me."
          ],
          choices: [
            { label: "Back to writing.", goto: "end" },
            { label: "Stay with me.", goto: "stay_1" }
          ]
        },
        thanks_1: {
          lines: [
            "You‚Äôre welcome, {{name}}.",
            "Anytime, {{name}}."
          ],
          choices: [
            { label: "Stay with me.", goto: "stay_1" },
            { label: "Back to writing.", goto: "end" }
          ]
        },
        mute_1: {
          lines: [
            "Okay. I‚Äôll go quiet.\n\nIf you want me back, tap the Boo icon."
          ],
          choices: [
            { label: "Okay.", goto: "end" }
          ]
        },
        stay_1: {
          lines: [
            "I‚Äôm here, {{name}}.\n\nYou don‚Äôt have to write a lot. Just one honest line.",
            "I‚Äôm staying close, {{name}}.\n\nTake your time."
          ],
          choices: [
            { label: "What‚Äôs on your mind?", goto: "ask_mind_1" },
            { label: "Earlier‚Ä¶ what was I thinking about?", goto: "recall_1" },
            { label: "Back to writing.", goto: "end" }
          ]
        },
        ask_mind_1: {
          lines: [
            "What‚Äôs on your mind right now, {{name}}?",
            "What are you carrying as you write, {{name}}?"
          ],
          choices: [
            { label: "I‚Äôll type it.", goto: "capture_note_1" },
            { label: "Not sure.", goto: "end_soft_1" },
            { label: "Back to writing.", goto: "end" }
          ]
        },
        capture_note_1: {
          lines: [
            "Okay, {{name}}.\n\nType a sentence or two ‚Äî I‚Äôll remember the shape of it."
          ],
          input: { placeholder: "A sentence or two‚Ä¶", storeAs: "note", hint: "This stays on this device." },
          choices: [
            { label: "Save", goto: "saved_note_1", effects: [{ type:"appendNote", tag:"mind" }] },
            { label: "Never mind", goto: "end" }
          ]
        },
        saved_note_1: {
          lines: [
            "Thank you, {{name}}. I‚Äôll hold that gently."
          ],
          choices: [
            { label: "Back to writing.", goto: "end" }
          ]
        },
        recall_1: {
          lines: [
            "{{recallLine}}"
          ],
          choices: [
            { label: "Thank you, Boo‚Ä¶", goto: "thanks_1", effects: [{ type:"affinity", delta: 1 }] },
            { label: "Say less‚Ä¶", goto: "mute_1", effects: [{ type:"set", key:"booMuted", value:true }] },
            { label: "Back to writing.", goto: "end" }
          ]
        },
        end_soft_1: {
          lines: [
            "That‚Äôs okay, {{name}}.\n\nYou don‚Äôt have to name it to let it move."
          ],
          choices: [
            { label: "Back to writing.", goto: "end" }
          ]
        },
        end: { lines: [""] }
      }
    };

    let booData = null;

    function loadBooState(){
      try {
        const raw = localStorage.getItem(BOO_STATE_KEY);
        if (!raw) return { booMuted:false, affinity:0, notes:[], name:"", seen:{} };
        const parsed = JSON.parse(raw);
        return {
          booMuted: !!parsed.booMuted,
          affinity: Number(parsed.affinity || 0),
          notes: Array.isArray(parsed.notes) ? parsed.notes : [],
          name: typeof parsed.name === "string" ? parsed.name : "",
          hasMetBoo: !!parsed.hasMetBoo,
          seen: typeof parsed.seen === "object" && parsed.seen ? parsed.seen : {}
        };
      } catch {
        return { booMuted:false, affinity:0, notes:[], name:"", seen:{} };
      }
    }
    function saveBooState(state){
      localStorage.setItem(BOO_STATE_KEY, JSON.stringify(state));
    }

    function openBooPanel(){
      booPanel.classList.add("active");
    }
    function closeBooPanel(){
      booPanel.classList.remove("active");
      booChoicesEl.innerHTML = "";
      booLinesEl.textContent = "";
      booInputWrap.classList.remove("active");
      booInput.value = "";
      editor.focus();
    }

    function pickNonRepeatingLine(sceneId, lines, state){
      if (!Array.isArray(lines) || lines.length === 0) return "";
      state.seen ||= {};
      state.seen[sceneId] ||= { pool: [] };

      const bucket = state.seen[sceneId];

      if (!Array.isArray(bucket.pool) || bucket.pool.length === 0) {
        bucket.pool = lines.slice();
        for (let i = bucket.pool.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [bucket.pool[i], bucket.pool[j]] = [bucket.pool[j], bucket.pool[i]];
        }
      }

      const next = bucket.pool.pop();
      saveBooState(state);
      return String(next || "");
    }

    function latestNoteText(state){
      const notes = state.notes || [];
      if (notes.length === 0) return "";
      const last = notes[notes.length - 1];
      return (last && last.text) ? String(last.text) : "";
    }

    function renderScene(sceneId){
      const state = loadBooState();
      const scenes = booData?.scenes || DEFAULT_SCENES.scenes;
      const scene = scenes[sceneId] || scenes["intro_1"];

      // input handling
      booInputWrap.classList.remove("active");
      booInput.value = "";
      booInput.dataset.storeAs = "";
      booHintEl.textContent = "";

      // templates
      const rawName = (state.name || "").trim();
      const safeName = rawName || "friend"; // fallback so {{name}} never becomes blank
      const note = latestNoteText(state);

      // recall line (verbatim note; no interpretation)
      const recallLine = note
        ? `Hey ${safeName}‚Ä¶ earlier you were thinking about:\n‚Äú${note}‚Äù\n\nHow is it now?`
        : `Hey ${safeName}‚Ä¶ I don‚Äôt have anything saved yet.\n\nIf you want, tell me what‚Äôs on your mind.`;

      let rawLine = pickNonRepeatingLine(sceneId, scene.lines || [""], state);

      rawLine = rawLine
        .replaceAll("{{name}}", safeName)
        .replaceAll("{{recallLine}}", recallLine);

      booLinesEl.textContent = rawLine;

      if (scene.input && typeof scene.input === "object") {
        booInputWrap.classList.add("active");
        booInput.placeholder = scene.input.placeholder || "";
        booInput.dataset.storeAs = scene.input.storeAs || "note";
        booHintEl.textContent = scene.input.hint || "";
        setTimeout(() => booInput.focus(), 40);
      }

      booChoicesEl.innerHTML = "";
      const choices = Array.isArray(scene.choices) ? scene.choices : [];

      for (const ch of choices) {
        const btn = document.createElement("button");
        btn.className = "booChoiceBtn";
        btn.type = "button";
        btn.textContent = ch.label || "‚Ä¶";
        btn.onclick = () => {
          applyEffects(ch.effects || []);
          const next = ch.goto || "end";
          if (next === "end") return closeBooPanel();
          renderScene(next);
        };
        booChoicesEl.appendChild(btn);
      }

      saveBooState(state);
    }

    function applyEffects(effects){
      const state = loadBooState();
      for (const eff of effects) {
        if (!eff || typeof eff !== "object") continue;

        if (eff.type === "set") {
          state[eff.key] = eff.value;
        }

        if (eff.type === "affinity") {
          const d = Number(eff.delta || 0);
          state.affinity = Number(state.affinity || 0) + d;
        }

        if (eff.type === "appendNote") {
          const text = (booInput.value || "").trim();
          if (text) {
            state.notes ||= [];
            state.notes.push({
              ts: nowIso(),
              tag: eff.tag || (booInput.dataset.storeAs || "note"),
              text
            });
          }
        }
      }
      saveBooState(state);
    }

    async function loadBooScenesOnce(){
      if (booData) return booData;
      try {
        const res = await fetch(BOO_SCENES_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("Failed to fetch scenes.json");
        const json = await res.json();
        if (!json || typeof json !== "object" || !json.scenes) throw new Error("Invalid scenes.json");
        booData = json;
        return booData;
      } catch {
        booData = DEFAULT_SCENES;
        return booData;
      }
    }

    async function summonBoo(){
      if (!writerScreen.classList.contains("active")) return;
      if (openOverlay.classList.contains("active")) return;
      if (finishOverlay.classList.contains("active")) return;
      if (privacyOverlay.classList.contains("active")) return;

      const state = loadBooState();
      const data = await loadBooScenesOnce();
      const allowSummonWhenMuted = !!(data.meta && data.meta.allowSummonWhenMuted);

      if (state.booMuted && !allowSummonWhenMuted) return;

      openBooPanel();
      if (!state.hasMetBoo) {
        state.hasMetBoo = true;
        saveBooState(state);
        renderScene("intro_1");
      } else {
        renderScene("stay_1");
      }
    }

    // Close Boo on ESC if open
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && booPanel.classList.contains("active")) {
        e.preventDefault();
        closeBooPanel();
      }
    });

    booCloseBtn.addEventListener("click", closeBooPanel);
    booIconBtn?.addEventListener("click", (e) => {
      e.preventDefault();
      summonBoo();
    });

    // ---------------------------
    // Name capture (quiet + local)
    // ---------------------------
    function setUserName(name){
      const cleaned = String(name || "").trim().replace(/\s+/g, " ").slice(0, 32);
      const state = loadBooState();
      state.name = cleaned;
      saveBooState(state);
    }

    function proceedFromName(){
      const typed = (nameInput.value || "").trim();
      // Allow empty -> fallback "friend"
      setUserName(typed);
      // initialize documents and go to writer
      const docs = loadDocs();
      const last = localStorage.getItem(SESSION_KEY);
      if (!last || !docs[last]) {
        newDocument();
      } else {
        currentDocId = last;
        openDocument(currentDocId);
      }
      fadeToWriter();
    }

    // Events
    beginBtn.addEventListener("click", () => {
      fadeToName();
    });

    nameContinueBtn.addEventListener("click", proceedFromName);
    nameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter"){
        e.preventDefault();
        proceedFromName();
      }
    });

    function init(){
      runWelcomeAnimation();

      const s = loadSettings();
      if (s.fontFamily) fontSelect.value = s.fontFamily;
      if (s.fontSizeUI) fontSize.value = String(s.fontSizeUI);
      if (s.alignment) alignment = s.alignment;
      if (typeof s.indentEnabled === "boolean") indentEnabled = s.indentEnabled;
      applyTypography();

      resetHistory();
      pushHistory("");

      const last = localStorage.getItem(SESSION_KEY);
      if (last) currentDocId = last;

      // if name already exists, prefill
      const bs = loadBooState();
      if (bs.name) nameInput.value = bs.name;
    }

    openBtn.addEventListener("click", () => {
      renderDocList();
      showOverlay(openOverlay);
    });
    closeOpenOverlay.addEventListener("click", () => hideOverlay(openOverlay));
    newDocBtn.addEventListener("click", () => {
      newDocument();
      hideOverlay(openOverlay);
    });

    saveBtn.addEventListener("click", saveCurrent);

    finishBtn.addEventListener("click", () => {
      saveCurrent();
      showOverlay(finishOverlay);
    });

    downloadRtfBtn.addEventListener("click", downloadRtf);
    emailExportBtn.addEventListener("click", emailExport);

    restartBtn.addEventListener("click", () => {
      hideOverlay(finishOverlay);
      fadeToWelcome();
    });

    privacyLink.addEventListener("click", (e) => {
      e.preventDefault();
      showOverlay(privacyOverlay);
    });
    closePrivacy.addEventListener("click", () => hideOverlay(privacyOverlay));

    fontSelect.addEventListener("change", applyTypography);
    fontSize.addEventListener("change", applyTypography);

    alignLeftBtn.addEventListener("click", () => { alignment = "left"; applyTypography(); });
    alignJustifyBtn.addEventListener("click", () => { alignment = "justify"; applyTypography(); });
    indentBtn.addEventListener("click", () => { indentEnabled = !indentEnabled; applyTypography(); });

    undoBtn.addEventListener("click", undo);
    redoBtn.addEventListener("click", redo);

    // Track typing with gentle snapshotting
    let snapshotTimer = null;
    editor.addEventListener("input", () => {
      if (applyingHistory) return;
      clearTimeout(snapshotTimer);
      snapshotTimer = setTimeout(() => {
        pushHistory(getPlainText());
      }, 350);
    });

    // Shortcuts
    document.addEventListener("keydown", (e) => {
      const isMac = navigator.platform.toUpperCase().includes("MAC");
      const mod = isMac ? e.metaKey : e.ctrlKey;

      if (e.key === "Escape"){
        if (openOverlay.classList.contains("active")) return hideOverlay(openOverlay);
        if (finishOverlay.classList.contains("active")) return hideOverlay(finishOverlay);
        if (privacyOverlay.classList.contains("active")) return hideOverlay(privacyOverlay);
      }

      if (!mod) return;
      const k = e.key.toLowerCase();

      if (k === "s"){
        e.preventDefault();
        saveCurrent();
      }
      if (k === "z"){
        e.preventDefault();
        if (e.shiftKey) redo();
        else undo();
      }
      if (k === "y"){
        e.preventDefault();
        redo();
      }
      if (k === "o"){
        e.preventDefault();
        renderDocList();
        showOverlay(openOverlay);
      }
    });

    for (const ov of [openOverlay, finishOverlay, privacyOverlay]){
      ov.addEventListener("click", (e) => {
        if (e.target === ov) hideOverlay(ov);
      });
    }

    init();
  </script>
</body>
</html>
